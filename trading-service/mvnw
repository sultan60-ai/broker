#!/usr/bin/env sh
set -eu

BASE_DIR=$(cd "$(dirname "$0")"; pwd -P)
WRAPPER_DIR="$BASE_DIR/.mvn/wrapper"
WRAPPER_JAR="$WRAPPER_DIR/maven-wrapper.jar"
PROPS_FILE="$WRAPPER_DIR/maven-wrapper.properties"

WRAPPER_URL=$(grep -E '^wrapperUrl=' "$PROPS_FILE" | cut -d'=' -f2- || true)
if [ -z "${WRAPPER_URL:-}" ]; then
  WRAPPER_URL="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.3.2/maven-wrapper-3.3.2.jar"
fi

download() {
  url="$1"
  dest="$2"
  mkdir -p "$(dirname "$dest")"
  if command -v curl >/dev/null 2>&1; then
    curl -fSL "$url" -o "$dest"
    return 0
  fi
  if command -v wget >/dev/null 2>&1; then
    wget -q "$url" -O "$dest"
    return 0
  fi
  echo "ERROR: Neither curl nor wget found to download Maven Wrapper." >&2
  return 1
}

if [ ! -f "$WRAPPER_JAR" ]; then
  echo "Downloading Maven Wrapper..."
  download "$WRAPPER_URL" "$WRAPPER_JAR"
fi

if [ -n "${JAVA_HOME:-}" ] && [ -x "$JAVA_HOME/bin/java" ]; then
  JAVA_EXE="$JAVA_HOME/bin/java"
else
  JAVA_EXE="java"
fi

export MAVEN_PROJECTBASEDIR="$BASE_DIR"
exec "$JAVA_EXE" -Dmaven.multiModuleProjectDirectory="$BASE_DIR" -classpath "$WRAPPER_JAR" org.apache.maven.wrapper.MavenWrapperMain "$@"
